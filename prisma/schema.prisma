// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organisation {
  id           String         @id @default(cuid())
  name         String
  timezone     String         @default("Australia/Sydney")
  active       Boolean        @default(true)
  stations     Station[]
  members      Member[]
  categories   Category[]
  users        User[]
  devices      Device[]
  auditLogs    AuditLog[]
  notices      Notification[]
  configs      Config[]
  kioskInvites KioskInvite[]
  memberTags   MemberTag[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Station {
  id             String              @id @default(cuid())
  organisationId String
  name           String
  code           String
  active         Boolean             @default(true)
  organisation   Organisation        @relation(fields: [organisationId], references: [id])
  devices        Device[]
  sessions       Session[]
  userAccesses   UserStationAccess[]
  kioskInvites   KioskInvite[]
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([organisationId, code])
}

model Device {
  id             String       @id @default(cuid())
  organisationId String
  stationId      String
  name           String
  kioskKey       String       @unique
  active         Boolean      @default(true)
  lastSeenAt     DateTime?
  organisation   Organisation @relation(fields: [organisationId], references: [id])
  station        Station      @relation(fields: [stationId], references: [id])
  sessions       Session[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Member {
  id             String @id @default(cuid())
  organisationId String

  // Primary ID
  firegroundNumber String

  // Identity
  firstName String
  lastName  String

  // Secondary ID (NOT UNIQUE - can be shared)
  mobile           String? // as entered
  mobileNormalized String? // canonical "04xxxxxxxx"

  isVisitor Boolean  @default(false)
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Organisation Organisation @relation(fields: [organisationId], references: [id])
  Token        Token[]
  Session      Session[]
  tags         MemberTag[]

  @@unique([organisationId, firegroundNumber])
  @@index([organisationId, isVisitor])
  @@index([organisationId, mobileNormalized])
}

model MemberTag {
  id             String   @id @default(cuid())
  organisationId String
  memberId       String
  tagValue       String
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id])
  member       Member       @relation(fields: [memberId], references: [id])

  // One physical tag value is unique per org (even if inactive). Reassignment is done by updating memberId.
  @@unique([organisationId, tagValue])
  @@index([organisationId, active])
  @@index([memberId])
}

enum MemberType {
  member
  visitor
}

model Token {
  id        String    @id @default(cuid())
  memberId  String
  type      TokenType
  valueHash String
  last4     String
  active    Boolean   @default(true)
  createdAt DateTime  @default(now())
  member    Member    @relation(fields: [memberId], references: [id])

  @@index([valueHash])
}

enum TokenType {
  mobile
  rfid
  pin
}

model Session {
  id             String        @id @default(cuid())
  memberId       String
  organisationId String
  stationId      String
  deviceId       String?
  startTime      DateTime
  endTime        DateTime?
  duration       Int? // minutes (derived)
  rawCheckinAt   DateTime
  rawCheckoutAt  DateTime?
  editLevel      EditLevel     @default(none) // none | self | admin
  editedById     String?
  status         SessionStatus @default(open)
  tasks          SessionTask[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  visitorAgency  String?
  visitorPurpose String?

  member  Member  @relation(fields: [memberId], references: [id])
  station Station @relation(fields: [stationId], references: [id])
  device  Device? @relation(fields: [deviceId], references: [id])

  @@index([memberId, status])
  @@index([organisationId, stationId])
}

enum EditLevel {
  none
  self
  admin
}

enum SessionStatus {
  open
  closed
  corrected
}

model Category {
  id             String  @id @default(cuid())
  organisationId String
  parentId       String?
  name           String
  code           String // immutable once used in activity
  active         Boolean @default(true)
  sort           Int     @default(0)

  organisation Organisation @relation(fields: [organisationId], references: [id])
  parent       Category?    @relation("CategoryToCategory", fields: [parentId], references: [id])
  children     Category[]   @relation("CategoryToCategory")

  tasks SessionTask[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organisationId, code]) // code unique per org
  @@index([organisationId, parentId, sort])
}

model SessionTask {
  id         String @id @default(cuid())
  sessionId  String
  categoryId String

  // duration etc.
  minutes Int
  notes   String?

  // snapshots for reporting longevity (do not change once written)
  categoryCodeSnapshot String @default("")
  categoryNameSnapshot String @default("")

  session  Session  @relation(fields: [sessionId], references: [id])
  category Category @relation(fields: [categoryId], references: [id])

  @@index([sessionId])
}

model User {
  id              String              @id @default(cuid())
  organisationId  String
  email           String              @unique
  name            String?
  role            String              @default("site_manager")
  organisation    Organisation        @relation(fields: [organisationId], references: [id])
  stationAccesses UserStationAccess[]
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
}

model UserStationAccess {
  id        String   @id @default(cuid())
  userId    String
  stationId String
  role      String   @default("site_manager")
  user      User     @relation(fields: [userId], references: [id])
  station   Station  @relation(fields: [stationId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, stationId])
}

model AuditLog {
  id             String       @id @default(cuid())
  organisationId String
  userId         String?
  action         String
  entityType     String
  entityId       String?
  message        String?
  meta           Json?
  createdAt      DateTime     @default(now())
  organisation   Organisation @relation(fields: [organisationId], references: [id])

  @@index([organisationId, createdAt])
}

model Notification {
  id             String   @id @default(cuid())
  organisationId String
  type           String
  message        String
  active         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id])

  @@index([organisationId, active])
}

model Config {
  id             String   @id @default(cuid())
  organisationId String
  key            String
  value          String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organisation Organisation @relation(fields: [organisationId], references: [id])

  @@unique([organisationId, key])
}

model KioskInvite {
  id             String @id @default(cuid())
  organisationId String
  stationId      String
  passphraseHash String

  // Human-friendly code shown to the admin / entered on device
  phraseDisplay String

  // Added previously (your DB already has this and itâ€™s populated)
  kioskName String @default("")

  expiresAt DateTime

  // Existing DB fields (do NOT drop)
  used      Boolean   @default(false)
  usedAt    DateTime?
  createdBy String?
  createdAt DateTime  @default(now())

  organisation Organisation @relation(fields: [organisationId], references: [id])
  station      Station      @relation(fields: [stationId], references: [id])

  @@index([organisationId, stationId, used])
  @@index([expiresAt])
}
